


  

### **🧭 전체 흐름 구조 (상위 3단계)**

```
1. 시스템 초기화 (관리자 관점)
2. 일반 사용자 이용 흐름
3. 운영 및 예외 처리 (관리자 관점)
```

---

## **🔁 1단계: 시스템 초기화 –** 

## **관리자 최초 셋업 흐름**

| **단계** | **설명**                | **필요한 기능**                         |     |
| ------ | --------------------- | ---------------------------------- | --- |
| 1-1    | 기관 또는 공간 단위 시스템 초기화   | 기관(기숙사) 정보 등록, 위치(동/층/호실 등) 정의     | 설계만 |
| 1-2    | 관리자 계정 생성             | 역할(Role), 권한, 계정 상태 관리             | 설계만 |
| 1-3    | 기기 등록                 | 기기명, 위치, NFC/QR 정보, 초기 상태 등록       | 설계만 |
| 1-4    | 유지보수 시간 등록 (예약 차단 구간) | 예약 불가 시간대 사전 등록 기능                 | mvp |
| 1-5    | 사용자 계정 생성/초대          | 내부 사용자 명단 연동 or 사용자가 직접 가입 (제어 가능) | mvp |
| 1-6    | 알림 정책 설정              | 어떤 이벤트에 알림을 보낼지 사전 정의              | 설계만 |

> 🔧 **초기 세팅이 끝나면**, 이제 사용자는 서비스를 이용할 수 있음.

---

## **👤 2단계: 일반 사용자 이용 흐름 –** 

## **일상적 사용 시나리오**

| **단계** | **설명**         | **필요한 기능**                    |     |
| ------ | -------------- | ----------------------------- | --- |
| 2-1    | 로그인 / 마이페이지 접근 | 로그인, 내 예약/신고/알림 확인            | mvp |
| 2-2    | 기기 목록 확인       | 위치/상태별 필터, 즐겨찾기 가능            | mvp |
| 2-3    | 출발해요 요청        | 중복 예약 차단, DEPARTURE 상태 저장     | mvp |
| 2-4    | 도착 인증 (NFC)    | 시간 내 인증 시 ARRIVAL 상태 전환       | mvp |
| 2-5    | 사용 등록          | 실제 세탁기 사용 시점, IN_USE 상태 전환    | mvp |
| 2-6    | 무단사용 신고        |                               | mvp |
| 2-7    | 사용 종료          | DONE 상태로 전환 (타이머 or 수동)       | mvp |
| 2-8    | 회수 완료          | 사용자가 회수 후 직접 AVAILABLE 상태로 변경 | mvp |
| 2-9    | 이력 조회          | 완료된 사용 기록 조회                  | mvp |
| 예외     | 도착 인증 실패       | 자동 상태 전환, 알림전송                | mvp |
|        | 회수 지연          | 알림 전송, 패널티 기록                 | mvp |

---

## **🛠 3단계: 운영 및 예외 처리 –** 

## **관리자 실시간 대응 흐름**

| **단계** | **설명**        | **필요한 기능**                        |     |
| ------ | ------------- | --------------------------------- | --- |
| 3-1    | 고장 신고 확인      | 사용자 신고 접수 → CONFIRMED/RESOLVED 처리 | mvp |
| 3-2    | 무단 사용 신고 확인   | 사용자의 신고 처리 및 경고 누적 확인             |     |
| 3-3    | 기기 상태 수동 변경   | 고장 상태 직접 설정 or 예약 해제 처리           | mvp |
| 3-4    | 사용자 제재        | 거짓 신고, 무단 사용 누적 시 수동 조치           |     |
| 3-5    | 알림 발송         | 자동 or 수동 공지 발송 기능                 | mvp |
| 3-6    | 통계 조회 (추후 확장) | 기기 가동률, 사용자 행동 통계 대시보드            |     |
|        |               |                                   |     |

# **1-1. 기관 및 관리자 생성 (MVP 이후 확장 시 적용)**
---

> **AdminUserService.create() 같은 공통 생성 함수**를 만들어두면,

> 관리자를 만들 때마다 중복되는 계정 생성 로직을 한 곳에서 관리할 수 있어서

> **나중에 /admin/request 신청 기반 생성이든, 수동 생성이든 코드 충돌 없이 재사용**할 수 있어.

public class AdminUserService {
    public void create(String email, String institutionName, String purpose) {
        // 기관 생성 or 찾기
        Institution institution = institutionsRepository.findOrCreate(institutionName);
        
        // 사용자 생성
        User admin = new User(email, defaultPassword, Role.ADMIN);
        admin.setInstitution(institution);
        admin.setStatus(ACTIVE);
        usersRepository.save(admin);

        // 초기 설정 로그/알림 등 확장 가능
    }
}

그래서 처음 mvp에서 수동으로 관리자 계정을 만들든, 확장해서 자동으로 관리자 계정을 만들든
adminUserService.create(email, institutionName, purpose); 이것만 쓰면됨


---

## **✅ 1-2. 관리자 초기 설정 – 구조 및 흐름 요약**

---
### **🎯 목적**

> 승인된 관리자가 시스템에 로그인한 뒤,
> **공간, 자원, 정책**을 등록하여 실제 운영을 시작할 수 있도록 함.
---

### **🧭 주요 흐름**

```
[관리자 로그인]
→ 공간 등록 (동, 층, 공간 이름)
→ 자원 등록 (세탁기/청소기 등)
→ 예약 불가 시간 설정 (점검/유지보수 시간)
→ 자원 초기 상태 설정 (예: FAULT)
```

---
### **📁 기능별 세부 정의**

| **기능**      | **설명**                                | **필수 여부** | **주의사항**                    |
| ----------- | ------------------------------------- | --------- | --------------------------- |
| 공간 등록       | 동 → 층 → 공간의 계층 구조로 등록 (locations 테이블) | ✅         | institution_id + name 중복 방지 |
| 자원 등록       | 공간에 자원을 배치. 자원명, 자원유형, 초기 상태 포함       | ✅         | 위치 지정 필수, 중복명 방지            |
| 유지보수 시간 등록  | 특정 시간대 기기 예약 차단 (devices_maintenance) | ✅         | 시작시간 > 종료시간, 과거 시간 불가       |
| 자원 상태 수동 지정 | 초기 자원 상태를 고장/사용 불가 등으로 설정             | ✅         | 상태 변경 기록 로그 연계 가능           |
| 자원 비활성화 처리  | 사용하지 않을 자원 숨기기 (is_active = false)    | 🕒        | 삭제 대신 논리 삭제 권장              |

---
### **🧱 관련 테이블 요약**

| **테이블**             | **역할**      | **필수 필드**                                     |
| ------------------- | ----------- | --------------------------------------------- |
| locations           | 공간 등록       | name, parent_location_id, institution_id      |
| resources           | 자원 등록       | device_name, device_type, location_id, status |
| devices_maintenance | 예약 불가 시간 등록 | device_id, start_time, end_time               |
| device_status_logs  | 상태 변경 기록    | (추가 고려 대상)                                    |

---

### **🔐 예외 및 검증**

| **상황**   | **처리 방식**                                |
| -------- | ---------------------------------------- |
| 공간 중복 등록 | institution_id + name UNIQUE 제한          |
| 기기명 중복   | location_id + device_name 조합으로 UNIQUE 제한 |
| 시간 충돌    | 점검 시간이 겹치면 UI 경고 또는 서버 단 유효성 검증          |
| 초기 상태 오류 | 기본은 AVAILABLE, FAULT 상태 수동 설정 허용         |

---
### **🧠 UX 설계 고려 사항**

- 공간 등록 시 계층을 드롭다운 or 트리 구조로 구성
- 자원 상태는 컬러/아이콘으로 구분 표시
- 예약 불가 시간은 **캘린더 + 시계형** UI 활용
- 고장/비활성화 자원은 기본적으로 사용자 UI에 표시되지 않도록 설정
    

# **✅ 다음 점검 기능:** 

# **1-3. 기기 등록**

  

## **🎯 목적**

  

> 사용자가 사용할 수 있는 실제 자원(세탁기, 건조기 등)을 공간에 등록하고,

> 초기 상태 및 기기 유형을 설정하여 시스템이 추적/제어할 수 있도록 함.

---

## **📁 핵심 기능 정의**

|**항목**|**설명**|
|---|---|
|기능명|기기 등록 (POST /resources)|
|필수 입력|device_name, device_type, location_id, status, nfc_tag_url (nullable)|
|기본값|status 기본값은 AVAILABLE|
|관계|location_id → locations 테이블 FK, institution은 간접적으로 연결됨|
|중복 방지|(location_id + device_name) UNIQUE 조건 추천|

---

## **🔎 예외 및 검증**

|**예외 상황**|**처리 방식**|
|---|---|
|중복 기기명|동일 공간 내에서는 등록 불가로 처리 (UNIQUE 제약)|
|존재하지 않는 위치|등록 불가. 등록된 공간에서만 기기 추가 가능|
|상태값 누락|기본값 AVAILABLE로 설정|
|NFC/QR 누락|nfc_tag_url은 nullable 처리. 이후 수정 가능|

---

## **🔧 DB 테이블 요약 (resources)**

```
CREATE TABLE resources (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_name VARCHAR(50) NOT NULL,
    device_type VARCHAR(30) NOT NULL,
    location_id INT NOT NULL,
    status ENUM('AVAILABLE', 'IN_USE', 'DONE', 'UNREGISTERED_USE', 'FAULT_REPORTED', 'FAULT_CONFIRMED', 'OUT_OF_SERVICE') DEFAULT 'AVAILABLE',
    nfc_tag_url VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## **📦 향후 확장 고려**

| resource_group_id | 묶음 단위 제어용 (예: 세탁기 그룹) |
| ----------------- | --------------------- |


---

## **🎨 UX 측면 고려사항**

- 등록 시 드롭다운으로 위치 선택 (동 → 층 → 공간)
    
- NFC은 “나중에 입력” 체크박스
    
- 등록 직후 기기 상태 색상/아이콘으로 확인 가능하게 설계
    

좋아, 그럼 **유지보수 시간 등록 기능은 다음과 같이 변경 및 확정**할 수 있어:

---

# **✅ 1-4 유지보수 시간 등록 – 확정 구조 (v2)**

  

## **🎯 목적**

  

> **특정 공간 단위로 유지보수 시간(예약 차단 시간)**을 설정하면,

> 해당 공간에 포함된 모든 자원이 자동으로 해당 시간대에 예약 불가 상태로 간주됨.

---

## **🧭 흐름 요약**

```
[관리자] → 공간 선택 (예: 1층 세탁실)
        → 요일, 시간 입력
        → [등록] 클릭 → 해당 공간의 모든 자원에 자동 적용

초기 설정 외에도: 수정, 삭제 가능
```

---

## **📁 기능 사양 (수정 후 기준)**

|**항목**|**설명**|
|---|---|
|대상|location_id (공간 기준)|
|영향 범위|해당 공간에 포함된 모든 자원 (resources.location_id = 해당 id)|
|반복 여부|요일별 반복 (월~일)|
|시간 단위|start_time, end_time (TIME)|
|수정/삭제|관리자 페이지에서 언제든 가능|

---

## **🧱 테이블 설계 (v2)**

```
CREATE TABLE location_maintenance_times (
    id INT AUTO_INCREMENT PRIMARY KEY,
    location_id INT NOT NULL,
    weekday ENUM('MON','TUE','WED','THU','FRI','SAT','SUN') NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (location_id) REFERENCES locations(id)
);
```

---

## **🔍 사용자 차단 로직**

```
-- 사용자가 /resources/:id/use 요청 시
-- 해당 자원의 location_id로 유지보수 시간 조회

SELECT 1
FROM location_maintenance_times
WHERE location_id = :locationId
  AND weekday = CURRENT_WEEKDAY
  AND :currentTime BETWEEN start_time AND end_time
```

> ✅ 결과가 있으면 → 사용 등록 차단 (409 Conflict 또는 사용자 메시지)

---

## **✏️ 수정 및 삭제 흐름**

- 수정: 기존 요일/시간 정보를 선택하여 편집 후 저장
    
- 삭제: 유지보수 구간 하나씩 제거 가능 (DELETE FROM location_maintenance_times WHERE id = ?)
    
- 관리자 페이지에서 **공간별 유지보수 시간 목록** 조회 가능
    
.

---


# **1-5. 사용자 계정 생성 / 초대**


---

## **🎯 목적**

  

> 기관에서 전달받은 사용자 정보를 기반으로 시스템에 계정을 등록하고,

> 자동으로 권한 그룹에 배정하여 **공간 접근 제어와 사용 흐름을 가능하게 함**.

---

## **🧭 전체 흐름**

```
[관리자] → 사용자 정보 연동 (CSV or API)
        → users 테이블에 계정 생성
        → room_code 기준으로 그룹 자동 배정
        → user_group_memberships 생성
        → 이메일 있는 경우: 비밀번호 설정 링크 전송
        → 이메일 없는 경우: 관리자 수동 초기화
```

---

## **📥 입력값 (기관 시스템 제공 또는 CSV)**

|**필드**|**설명**|**필수**|
|---|---|---|
|external_user_id|외부 시스템의 고유 식별자|✅|
|name|사용자 이름|✅|
|email|이메일 (없을 수도 있음)|⭕|
|room_code|방 번호 (그룹 매핑 기준)|✅|
|institution_id|소속 기관 ID|✅|

---

## **📁 처리 로직**

  

### **① 사용자 계정 저장 (**

### **users**

### **)**

- (institution_id, external_user_id) 조합으로 중복 방지
    
- status = ACTIVE 기본
    
- 이메일이 없으면 비밀번호 초기화 제한
    

  

### **② 그룹 자동 배정**

- 그룹 정책 설정: BY_ROOM, BY_FLOOR, CUSTOM
    
- 예: room_code = 304호 → 그룹명 = group_304
    

```
-- 그룹이 없으면 생성
-- 자동 그룹 정책에 따라 users.last_grouping_value 기록
```

### **③** 

### **user_group_memberships**

###  **생성**

- N:N 구조: 사용자 1명 ↔ 여러 그룹 가능
    
- 해당 그룹의 공간 접근 권한은 location_access로 연결됨
    

---

## **🧱 관련 테이블 요약**

|**테이블**|**필드 요약**|
|---|---|
|users|id, name, email, status, room_code, institution_id|
|groups|id, name, type (BY_ROOM 등), institution_id|
|user_group_memberships|user_id, group_id|
|location_access|group_id ↔ location_id 권한 연결|

---

## **🔐 예외 처리 및 유효성 검증**

|**상황**|**처리 방식**|
|---|---|
|중복 external_user_id|❌ 등록 거절 (UNIQUE 제한)|
|이메일 없음|✅ 비밀번호 초기화 불가, 관리자 수동 초기화로 제한|
|그룹 배정 실패|❗ 로그 기록 후 수동 배정 요구|
|room_code 오류|❌ 그룹 생성/배정 실패로 사용자 등록 불완전 상태 표시|
|다른 기관 소속 중복|✅ institution_id 구분으로 방지됨|

---

## **🧠 UX/UI 설계 팁**

- CSV 업로드 시: 성공/실패 수 요약, 오류 행 표시
    
- API 연동 시: 응답 로그, 누락 필드 자동 검증
    
- 이메일 있는 경우: 비밀번호 설정 링크 전송 버튼 포함
    
- 사용자 상태 관리 가능: ACTIVE, INACTIVE, SUSPENDED
    

---

## **✅ 최종 점검 요약**

|**항목**|**상태**|
|---|---|
|자동 계정 생성|✅ 완료|
|그룹 자동 배정|✅ 정책별 처리 명확|
|예외 처리|✅ 중복, 오류, 누락 조건 대응 완료|
|DB 연동|✅ users, groups, user_group_memberships 구조 연결 명확|
|보안|✅ 비밀번호 초기화 분기 포함|
|확장성|✅ 다기관 구조, 사용자 다중 그룹 대응 가능|


---

# **✅** 

# **1-6. 알림 정책 설정 **

---

## **🎯 목적**

  

> 관리자 또는 시스템 운영자가,

> 어떤 이벤트 발생 시 사용자/관리자에게 어떤 방식으로 **알림을 전송할지 사전 정의**함으로써

> **실시간 커뮤니케이션 흐름**을 유연하게 설계하고 제어하기 위함.

---

## **🧭 전체 흐름**

```
[관리자 초기 설정 단계]
→ 알림 발생 조건 정의 (예: 사용 종료, 무단 사용)
→ 알림 수신 대상 정의 (사용자 / 관리자)
→ 알림 방식 선택 (웹 푸시, 알림센터 등)
→ 정책 저장 → 이벤트 발생 시 자동 알림 전송
```

---

## **📁 알림 대상 이벤트 예시**

|**이벤트 트리거**|**설명**|**기본 수신 대상**|
|---|---|---|
|사용 종료 임박|사용자가 등록한 시간 도달 전|사용자|
|사용 종료|사용자가 사용 종료|사용자|
|회수 지연|사용자가 회수하지 않음|사용자|
|무단 사용 신고 발생|누군가 무단 사용을 신고함|관리자|
|고장 신고 발생|고장이 신고됨|관리자|
|고장 상태 해제|고장이 해결되어 사용 가능해짐|사용자|
|수동 공지 발송|운영자 수동 입력|전체 or 선택 대상|

---

## **📋 알림 정책 테이블 예시**

```
CREATE TABLE notification_policies (
  id INT AUTO_INCREMENT PRIMARY KEY,
  event_type ENUM('RESERVATION_END', 'UNAUTHORIZED_USE', 'FAULT_REPORTED', 'FAULT_CONFIRMED', 'GENERAL') NOT NULL,
  target ENUM('USER', 'ADMIN', 'ALL') NOT NULL,
  delivery_method ENUM('WEB_PUSH', 'EMAIL', 'ALERT_CENTER') DEFAULT 'WEB_PUSH',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

> 🔔 실제 알림 발생 시 이 정책을 기준으로 notifications 테이블에 데이터 생성 → Web Push 또는 UI 표시 전송

---

## **🔧 알림 전송 구조**

|**단계**|**설명**|
|---|---|
|1. 정책 조회|해당 이벤트의 알림 정책 확인 (is_active = true)|
|2. 알림 생성|notifications 테이블에 INSERT|
|3. 전송 처리|Web Push API or 알림센터에 노출|

---

## **🧱 알림 로그 테이블**

```
CREATE TABLE notifications (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  device_id INT,
  type ENUM('RESERVATION_END', 'UNAUTHORIZED_USE', 'FAULT_REPORTED', 'FAULT_CONFIRMED', 'GENERAL') NOT NULL,
  message TEXT,
  status ENUM('SENT', 'READ') DEFAULT 'SENT',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## **🔐 예외 처리**

|**상황**|**처리 방식**|
|---|---|
|수신 대상 없음|알림 생성하지 않음|
|정책 비활성화|is_active = false일 경우 알림 발생 안 함|
|알림 실패 (Web Push 꺼짐)|사용자 알림센터에 fallback 저장|
|사용자 로그아웃 상태|알림은 기록되되, 다음 접속 시 UI로 알림|

---

## **🧠 UX 고려**

- **관리자 설정 UI**에서:
    
    - 이벤트 목록을 토글로 설정
        
    - 대상 선택 (USER / ADMIN)
        
    - 전송 방식 선택 (Web Push / AlertCenter 등)
        
    
- **사용자 UI**에서는:
    
    - 알림센터 + 실시간 Web Push 병행 표시
        
    - 예약 종료/회수 지연은 **배너 or 알림말풍선** 강조
        
    

---

## **✅ 최종 점검 요약**

|**항목**|**상태**|
|---|---|
|이벤트 트리거 정의|✅ 명확 (7개 이상 정의됨)|
|정책 구조 설계|✅ DB, 전송 방식, 대상 구분 구조 완비|
|실시간 전송 로직|✅ 정책 기반 → notifications 저장 → push 전송|
|예외 처리|✅ 비활성화, 실패 처리 플로우 명확|
|UX 흐름|✅ 관리자/사용자 모두 설계됨|
|확장 가능성|✅ 메일, 앱 알림 등 확장 가능 구조|

  
  
# **✅** 

# **2-1. 로그인 / 마이페이지 접근**

  

## **🎯 목적**

  

> 사용자가 본인 계정으로 로그인하고,

> 본인의 예약 상태, 사용 이력, 알림 내역 등을 확인할 수 있도록 함.

---

## **🧭 흐름 요약**

```
[사용자] → 로그인 (JWT 발급)
         → 마이페이지 접근 (/me)
         → 내 정보, 알림, 사용 내역 등 조회
```

---

## **📥 로그인 입력값**

|**필드**|**설명**|
|---|---|
|email|사용자 이메일|
|password|비밀번호 (최초 로그인 시 설정 or 관리자 초기화)|

---

## **📤 응답값**

|**필드**|**설명**|
|---|---|
|token|JWT 액세스 토큰|
|user|사용자 이름, 소속 그룹, 마지막 로그인 등|
|roles|USER / ADMIN 구분 포함 (role-based UI 제어용)|

---

## **📁 마이페이지 조회 정보 (GET /me)**

|**항목**|**설명**|**테이블**|
|---|---|---|
|내 프로필 정보|이름, 이메일, 소속 방|users, groups|
|사용 내역|현재 상태, 최근 사용 기록|usage_logs, resources|
|알림 내역|최근 받은 알림 (읽음 여부 포함)|notifications|
|신고 이력|내가 등록한 무단사용/고장 신고|incident_logs|

---

## **🧱 관련 테이블**

- users
    
- user_group_memberships, groups
    
- notifications
    
- incident_logs
    
- (선택적으로 usage_logs 또는 reservations)
    

---

## **🔐 예외 처리 및 보안**

|**예외 상황**|**처리**|
|---|---|
|이메일 없음 / 비밀번호 오류|401 Unauthorized|
|비활성 계정 (status != ACTIVE)|로그인 거절, 메시지 반환|
|JWT 위조 or 만료|403 Forbidden / 자동 로그아웃 처리|
|관리자/사용자 구분 필요 시|role == ADMIN 여부 확인 후 UI 렌더링 분기|

---

## **🧠 UX 설계 팁**

- 로그인 후  대시보드 형태 제공
    
- 알림은 **최신순 / 미확인 강조** UI 표시
    
- 예약 중인 자원이 있다면 상단 고정 강조 (예: “사용 중인 자원: 세탁기 1호”)
    

---

## **✅ 점검 요약**

|**항목**|**상태**|
|---|---|
|인증 구조|✅ JWT 기반 명확|
|데이터 흐름|✅ 프로필 → 알림 → 이력 흐름 적절|
|예외 처리|✅ 비활성, 오류, 만료 케이스 모두 커버|
|확장성|✅ 관리자와 사용자 분기 기반 UI도 연계 가능|
|UI/UX|✅ 마이페이지/대시보드 기본 제공, 알림/상태 강조 가능|

# **✅ 2-2. 기기 목록 확인 – 최종 정리**

---

## **🎯 목적**

  

> 사용자가 **자신이 접근할 수 있는 공간의 자원(기기) 목록**을 확인하고,

> 각 자원의 상태와 사용 가능 여부를 직관적으로 파악할 수 있도록 한다.

---

## **🧭 전체 흐름**

```
[로그인]
→ 내 소속 그룹 및 예외 권한 공간 목록 조회
→ 공간 목록을 탭으로 UI에 표시
→ 탭 클릭 시: 해당 공간의 자원 목록 조회
→ 상태별 필터링 + 현재 상태 표시
```

---

## **📁 관련 API**

  

### **① 접근 가능 공간 목록**

```
GET /my-locations
→ 사용자가 접근 가능한 공간 목록 반환
```

- 내부적으로:
    
    - user_group_memberships → location_access
        
    - - user_location_exceptions
            
        
    

  

### **② 공간별 자원 목록**

```
GET /resources?location_id=7
→ 공간 ID에 해당하는 기기 리스트
```

- 선택 필터:
    
    - status=AVAILABLE
        
    - search=세탁기
        
    

---

## **📤 응답 예시**

  

### **공간 목록 (탭용)**

```
[
  { "id": 7, "name": "1동 1층 세탁실" },
  { "id": 8, "name": "2동 2층 건조실" }
]
```

### **자원 목록**

```
[
  {
    "id": 101,
    "device_name": "세탁기 A",
    "device_type": "WASHER",
    "status": "AVAILABLE"
  },
  {
    "id": 102,
    "device_name": "세탁기 B",
    "device_type": "WASHER",
    "status": "IN_USE"
  }
]
```

---

## **🔐 권한 필터링 로직**

|**유형**|**쿼리 기준**|
|---|---|
|그룹 권한|users → user_group_memberships → location_access|
|예외 권한|user_location_exceptions + 유효시간 조건|

> 두 조건을 **UNION**하여 공간 목록 생성

---

## **🎯 상태 기준 UI 표시**

|**상태**|**설명**|**색상/아이콘 예시**|
|---|---|---|
|AVAILABLE|사용 가능|✅ 초록 / 체크|
|IN_USE|사용 중|🌀 파랑 / 회전|
|DONE|회수 대기|⏳ 노랑 / 완료 표시|
|UNREGISTERED_USE|무단 사용|❗ 빨강 / 경고|
|FAULT_REPORTED / CONFIRMED|고장|⚠️ 회색 / 경고|
|OUT_OF_SERVICE|폐기됨|❌ 숨김 처리 (UI에서 기본 비표시)|

---

## **🧠 UX 구조**

- 공간 = 탭 UI
    
- 기기 = 카드형 or 리스트형 표시
    
- 상태 필터 = 탭 내부 드롭다운 or 버튼 그룹
    
- 알림/고장 기기는 상태 강조
    

---

## **✅ 최종 점검 결과**

|**항목**|**상태**|
|---|---|
|권한 필터링|✅ 그룹 + 예외 통합 쿼리로 설계 완료|
|공간별 UI 구조|✅ 탭 기반 설계 반영|
|상태 Enum 표시|✅ 색상/아이콘 기준까지 정의|
|필터링/검색|✅ location, status, keyword 모두 적용 가능|
|사용자 예외 대응|✅ 숨김, 오류 처리 조건 명확함|

---


# **✅ 2-3. 출발해요 요청 **

---

## **🎯 목적**

  

> 사용자가 특정 기기를 **“곧 사용하겠다”는 의사를 시스템에 미리 알리고**,

> 해당 기기를 **일시적으로 예약 상태(DEPARTURE)** 로 전환하여 다른 사용자의 중복 사용을 방지한다.

---

## **🧭 흐름 요약**

```
[기기 목록 확인]
→ "출발해요" 버튼 클릭
→ 상태 = DEPARTURE 로 전환
→ 도착 인증 시간 제한 내 인증 필요
→ 인증 실패 시 상태 자동 초기화

(동일 사용자는 일정 시간 이후 다시 요청 가능)
```

---

## **📁 요청 API 예시**

```
POST /resources/:id/departure

Body:
{
  "user_id": 123
}
```

---

## **📦 DB 저장 구조 예시 (reservations 테이블 활용)**

|**필드**|**설명**|
|---|---|
|user_id|요청자|
|resource_id|대상 자원|
|status|DEPARTURE|
|departure_time|출발 요청 시각|
|arrival_deadline|도착 인증 제한 시간 (ex: 출발 시간 + 10분)|
|attempt_count|(선택) 사용자 출발 요청 횟수 제한 등 확장 시 사용|

---

## **🔁 상태 흐름**

```
AVAILABLE
   ↓ 출발 요청
DEPARTURE
   ↓ 도착 인증 성공
ARRIVAL
```

> 인증 실패 시 → DEPARTURE 만료 처리 → AVAILABLE 로 자동 전환

---

## **⏳ 재요청 조건 (반영됨)**

|**항목**|**설명**|
|---|---|
|요청 실패 후|동일 사용자는 일정 시간 텀(예: 10분)을 두고 다시 요청 가능|
|구현 방식|마지막 DEPARTURE 요청 시간 기준 → X분 후 재요청 허용|
|예외 메시지|“요청이 너무 빠릅니다. 잠시 후 다시 시도해주세요.” 등 안내 표시|

---

## **🔐 예외 처리**

|**예외 상황**|**처리 방식**|
|---|---|
|기기 상태 ≠ AVAILABLE|409 Conflict → 요청 거절|
|이미 DEPARTURE 중|중복 요청 거절|
|UNREGISTERED_USE 상태|요청 불가, 경고 메시지|
|요청 시간 텀 제한 위반|차단 후 알림 (다시 요청 가능 시간 안내)|

---

## **🧠 사용자 UI 흐름**

- “출발해요” 버튼 → 클릭 시 타이머 표시 (인증 마감 시간 안내)
    
- 현재 상태가 “사용 예정(출발 중)”임을 명확히 표시
    
- 도착 인증 실패 시 → 알림 또는 경고창 안내
    
- 다시 요청 가능한 시간 남은 경우 → 타이머 표시
    

---

## **✅ 최종 점검 요약**

|**항목**|**상태**|
|---|---|
|상태 전이|✅ AVAILABLE → DEPARTURE|
|시간 제한|✅ arrival_deadline 기반 자동 초기화|
|중복 요청 제한|✅ 사용자별 텀 제한 설계 반영|
|예외 처리|✅ 상태 충돌, 요청 제한 모두 포함|
|DB 연동|✅ reservations 기반 or 확장 가능|
|사용자 안내|✅ 타이머, 경고 메시지 포함 설계 가능|

---
2-4부터 3단계까지 쭉뽑고 한단계씩 복붙해서 수정하자
특히 nfc어케할까..




















//엣날에 정의한 것들

- 사용자기능

| **기능**         | **설명**                         |
| -------------- | ------------------------------ |
| ✅ 기기 상태 확인     | 사용 가능 / 사용 중 / 고장 상태 확인        |
| ✅ 사용 등록        | 빈 기기 선택 → 예상 사용 시간 입력 → 등록     |
| ✅ 사용 종료 / 회수   | 사용 후 완료 표시 → 회수 시간 기록          |
| ✅ 무단 사용 신고     | 비등록 상태 기기 사용 시 신고 가능           |
| ✅ 남은 시간 기록     | 무단 사용 중 기기에 남은 시간 수동 입력        |
| ✅ 알림 수신        | 예약 완료, 종료 임박, 공지 등 웹 알림 수신     |
| ✅ 알림 확인        | 접속 시 공지 팝업, 알림센터에서 확인          |
| ✅ 사용 내역 보기     | 자신의 등록 내역 및 회수 상태 확인           |
| ✅ 로그인 / 자동 로그인 | PWA에서 자동 로그인 (localStorage 기반) |

- 사용자 행동시나리오 기반 기능정리

| 사용자 행동              | 시스템 동작                                 | 관련 관리자 기능                         |
| ------------------- | -------------------------------------- | --------------------------------- |
| 기기 사용 시작            | 사용 등록 (예상 시간 입력) → 상태 `IN_USE` 전환      | 권한 확인 / 상태 기록 / 로그 저장             |
| 기기 사용 종료            | 사용 종료 버튼 → 회수 시간 자동입력 → 상태 `DONE`      | 회수율 반영 / 예약 통계 증가                 |
| 남이 무단 사용 중임         | 무단 사용 신고 → 상태 `SUSPECTED_IN_USE`       | 피신고자 기록 / 거짓신고 확인 / 경고 누적         |
| 내가 등록하지 않은 기기지만 돌아감 | 남은 시간 입력 → 상태 `IN_USE_UNREGISTERED`    | 관리자 확인 필요 알림 생성                   |
| 내 사용 내역 보기          | 사용 내역 조회 (상태/회수 포함)                    | 통계 반영, 사용자 활동 기록 열람               |
| 공지/알림 확인            | 접속 시 팝업 + 알림센터 내역 확인                   | 관리자 공지 작성/발송 로그 확인                |
| 고장신고                | 고장 신고 → 기기 상태 FAULT_REPORTED (신고 접수 중) | 관리자 접수 시 상태 FAULT_CONFIRMED 으로 전환 |
|                     |                                        |                                   |

---


    
- 관리자기능

| **기능**                    | **설명**                           |
| ------------------------- | -------------------------------- |
| ✅ 기기 등록 / 수정 / 삭제         | 공간 단위로 세탁기/건조기 관리                |
| ✅ 고장 처리                   | 고장 신고 기기 수리 상태 변경                |
| ✅ 권한 설정 (Room → Location) | 사용자 권한 배정 및 fallback/override 설정 |
| ✅ 사용자 관리                  | 사용자 목록 필터링, 상태 확인                |
| ✅ 관리자 계정 관리               | 계정 생성 / 비활성화 / 역할 변경             |
| ✅ 알림 작성 및 발송              | 특정 사용자 또는 전체 대상 공지 발송            |
| ✅ 통계 확인                   | 예약 수, 고장 수, 회수율 등 통계 확인          |
| ✅ 감사 로그 확인                | 관리자 행동 이력 확인 (AdminActionLog)    |
| Nfc 기기별 사용 가능여부 설정        |                                  |

- 관리자 행동흐름 기준 기능

|              |                                                         |
| ------------ | ------------------------------------------------------- |
| 관리자 행동       | 관련 기능 흐름                                                |
| 기기 설치        | 기기 등록 → 공간(Location) 지정 → 초기 상태 설정                      |
| 기기 고장 접수     | 고장 신고 상태 FAULT_REPORTED 확인 → 접수 시 상태 FAULT_CONFIRMED 변경 |
| 고장 처리 완료     | 상태 복구 (`AVAILABLE`) → 관리자 로그 기록                         |
| 사용자 권한 요청 처리 | Room → Location 권한 재배정 or override 설정                   |
| 회수율 모니터링     | 회수율/신고율/사용률 통계 확인 페이지 접속                                |
| 관리자 계정 관리    | 계정 생성/비활성화/역할 부여 → 상태/로그인 제한 적용                         |
| 정기 점검        | `last_login_at` 기준 미사용 관리자 파악 → 상태 변경 or 알림 발송          |
| 시스템 공지 작성    | Notification 생성 → 사용자 알림센터 + 팝업 전달                      |


---

## **🔁 공통 기능**

|**기능**|**설명**|
|---|---|
|✅ 로그인 / 인증 처리|JWT + role 기반 인증 처리|
|✅ 알림 수신 처리|PWA + Service Worker 알림 등록|
|✅ 권한 검사|role, institution_id 기반 API 접근 제어|
|✅ last_login_at 기록|로그인 시점 자동 업데이트|
|✅ 상태 동기화|예약 상태 자동 갱신 / 기기 상태 갱신 로직 포함|
- JWT 기반 로그인 + `role` 체크
    
- 모든 주요 테이블에 `institution_id` 포함 (멀티테넌시 구조)
    
- `AdminActionLog` 기록 구조 반영 (기기/권한/알림 관련 행동)
    
- 알림 구조: 웹 푸시 기반, 추후 카카오/밴드 등 확장 가능
    
- Soft Delete (`deleted_at`) 기반 삭제 설계 적용
 - 역할 기반 분리 예시

|**사용자 유형**|**기능 권한**|
|---|---|
|일반 사용자|사용 등록, 회수, 신고, 알림 확인|
|관리자 (MANAGER)|기기/고장/권한 관리, 일부 알림 가능|
|최고 관리자 (SUPER_ADMIN)|모든 권한, 계정 생성/관리, 감사 로그 확인|

  
### **[사용자 기능]**

| **기능**                | **설명**                                                                     |
| --------------------- | -------------------------------------------------------------------------- |
| **1. 로그인/로그아웃**       | - 사용자 로그인 / 로그아웃- PWA로 로그인 상태 유지 (localStorage)                            |
| **2. 출발해요**           | - 기기 선택 후 출발해요 신청- 10분간 도착 대기 상태로 전환- 도착하지 않으면 자동 취소 30분간 출발해요 기능 사용 불가    |
| **3. 도착해요 (NFC인증)**   | - NFC 스캔으로 도착해요 확인- NTAG 424 DNA 동적 URL로 사용자 인증- 인증 완료 시, 사용 등록 가능         |
| **4. 사용 등록**          | - 도착해요 완료 후, 사용 시간 설정 및 등록- 사용 시간 등록 시, 기기 상태 IN_USE로 전환                   |
| **5. 사용 종료 (회수 완료)**  | - 사용 완료 시, 사용 종료 버튼 클릭- 기기 상태를 DONE으로 변경하고 회수 시간 기록                        |
| **6. 무단 사용 신고**       | - 기기가 사용 중이 아닌데 사용 중으로 표시된 경우- 무단 사용 신고 가능- 관리자는 해당 신고를 검토하고, 무단 사용 상태로 전환 |
| **7. 상태 이상 신고**       | - 기기 고장 또는 상태 이상 발견 시 신고- 신고 상태 FAULT_REPORTED로 전환                         |
| **8. 내 기기 확인**        | - 현재 사용 중인 기기 목록 확인- 사용 시간, 남은 시간 표시                                       |
| **9. 알림 확인 (PWA 푸시)** | - 예약 시간 종료, 무단 사용 신고 등 주요 알림 수신- PWA 푸시 알림 및 알림센터에서 확인                     |
| **10. 마이페이지**         | - 사용자 정보 확인 및 비밀번호 변경- 내 신고 내역 / 내 기기 목록 확인                                |

---

### **✅** 

### **[관리자 기능]**

|**기능**|**설명**|
|---|---|
|**1. 관리자 로그인**|- 관리자 전용 로그인 화면|
|**2. 기기 등록/수정/삭제**|- 기기 정보 등록 (위치, 기기명, NFC/QR URL)- 기기 상태 변경 (AVAILABLE, IN_USE, FAULT_REPORTED)|
|**3. 출발해요 / 도착해요 관리**|- 출발해요 대기 중인 사용자 목록 확인- 도착해요 상태 강제 승인|
|**4. 무단 사용 신고 관리**|- 무단 사용 신고 내역 확인- 사용자에게 경고 알림 전송- 신고 내역 기록|
|**5. 상태 이상 신고 관리**|- 고장 신고 내역 확인- FAULT_CONFIRMED로 전환 후, 수리 진행|
|**6. 사용자 관리**|- 사용자 목록 확인- 특정 사용자 권한 변경- 사용 내역 조회|
|**7. 알림 발송**|- 특정 사용자 또는 전 사용자에게 공지 알림 발송|
|**8. 통계/로그 확인**|- 기기별 사용률, 무단 사용 신고 횟수, 고장 신고 내역 등 통계 제공|
|**9. 대체 권한 설정**|- 특정 기기 또는 공간이 고장난 경우- 임시 권한 부여하여 다른 기기 사용 가능하도록 설정|
|**10. 시스템 점검 모드**|- 전체 기기 상태 일괄 변경 (점검 중, 유지보수 중 등)|






### **✅** 

### **[알림 정책]**

| **이벤트**                                  | **알림 내용**                                 | **알림 대상** |
| ---------------------------------------- | ----------------------------------------- | --------- |
| **출발해요 대기 시작** (이미 한명이 있을시 대기줄 세워~? 말어?) | “출발해요가 시작되었습니다. 10분 내에 도착해요를 완료하세요.”      | 사용자       |
| **출발해요 취소됨**                             | “출발해요가 취소되었습니다. 다시 시도해 주세요.”              | 사용자       |
| **도착했어요 시작**                             | “도착했어요가 시작되었습니다. 5분 내에 사용 등록을 완료하세요.”     | 사용자       |
| **사용 등록 완료**                             | “세탁기 사용이 등록되었습니다. 사용 시간을 확인하세요.”          | 사용자       |
| **사용 종료 시간 도래**                          | “사용 시간이 5분 남았습니다. 세탁물을 회수해 주세요.”          | 사용자       |
| **회수 시간 초과**                             | “세탁물 회수 시간이 초과되었습니다. 다른 사용자가 신고할 수 있습니다.” | 사용자       |
| **무단 사용 신고 접수됨**                         | “무단 사용 신고가 접수되었습니다. 사용 내역을 확인해 주세요.”      | 관리자, 사용자  |
| **고장 신고 접수됨**                            | “기기 고장 신고가 접수되었습니다. 관리자에게 보고되었습니다.”       | 관리자, 사용자  |
| **관리자 공지 발송됨**                           | “시스템 점검 공지가 도착했습니다. 확인해 주세요.”             | 전체 사용자    |


외부 알림 연동 (카카오/밴드)|🔄 가능|구조만 준비, 실제 연동은 추후 선택|
