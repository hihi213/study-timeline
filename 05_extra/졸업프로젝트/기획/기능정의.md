


  

### **🧭 전체 흐름 구조 (상위 3단계)**

```
1. 시스템 초기화 (관리자 관점)
2. 일반 사용자 이용 흐름
3. 운영 및 예외 처리 (관리자 관점)
```

---

## **🔁 1단계: 시스템 초기화 –** 

## **관리자 최초 셋업 흐름**

| **단계** | **설명**                | **필요한 기능**                         |
| ------ | --------------------- | ---------------------------------- |
| 1-1    | 기관 또는 공간 단위 시스템 초기화   | 기관(기숙사) 정보 등록, 위치(동/층/호실 등) 정의     |
| 1-2    | 관리자 계정 생성             | 역할(Role), 권한, 계정 상태 관리             |
| 1-3    | 기기 등록                 | 기기명, 위치, NFC/QR 정보, 초기 상태 등록       |
| 1-4    | 유지보수 시간 등록 (예약 차단 구간) | 예약 불가 시간대 사전 등록 기능                 |
| 1-5    | 사용자 계정 생성/초대          | 내부 사용자 명단 연동 or 사용자가 직접 가입 (제어 가능) |
| 1-6    | 알림 정책 설정              | 어떤 이벤트에 알림을 보낼지 사전 정의              |

> 🔧 **초기 세팅이 끝나면**, 이제 사용자는 서비스를 이용할 수 있음.

---

## **👤 2단계: 일반 사용자 이용 흐름 –** 

## **일상적 사용 시나리오**

| **단계** | **설명**          | **필요한 기능**                    |
| ------ | --------------- | ----------------------------- |
| 2-1    | 로그인 / 마이페이지 접근  | 로그인, 내 예약/신고/알림 확인            |
| 2-2    | 기기 목록 확인        | 위치/상태별 필터, 즐겨찾기 가능            |
| 2-3    | 출발해요 요청         | 중복 예약 차단, DEPARTURE 상태 저장     |
| 2-4    | 도착 인증 (NFC/QR)  | 시간 내 인증 시 ARRIVAL 상태 전환       |
| 2-5    | 사용 등록           | 실제 세탁기 사용 시점, IN_USE 상태 전환    |
| 2-6    | 사용 종료           | DONE 상태로 전환 (타이머 or 수동)       |
| 2-7    | 회수 완료           | 사용자가 회수 후 직접 AVAILABLE 상태로 변경 |
| 2-8    | 이력 조회           | 완료된 사용 기록 조회                  |
| 예외     | 도착 인증 실패, 회수 지연 | 자동 상태 전환 or 알림 전송, 패널티 기록     |

---

## **🛠 3단계: 운영 및 예외 처리 –** 

## **관리자 실시간 대응 흐름**

|**단계**|**설명**|**필요한 기능**|
|---|---|---|
|3-1|고장 신고 확인|사용자 신고 접수 → CONFIRMED/RESOLVED 처리|
|3-2|무단 사용 신고 확인|사용자의 신고 처리 및 경고 누적 확인|
|3-3|기기 상태 수동 변경|고장 상태 직접 설정 or 예약 해제 처리|
|3-4|사용자 제재|거짓 신고, 무단 사용 누적 시 수동 조치|
|3-5|알림 발송|자동 or 수동 공지 발송 기능|
|3-6|통계 조회 (추후 확장)|기기 가동률, 사용자 행동 통계 대시보드|

# **1-1. 기관 및 관리자 생성 (MVP 이후 확장 시 적용)**
---

> **AdminUserService.create() 같은 공통 생성 함수**를 만들어두면,

> 관리자를 만들 때마다 중복되는 계정 생성 로직을 한 곳에서 관리할 수 있어서

> **나중에 /admin/request 신청 기반 생성이든, 수동 생성이든 코드 충돌 없이 재사용**할 수 있어.

public class AdminUserService {
    public void create(String email, String institutionName, String purpose) {
        // 기관 생성 or 찾기
        Institution institution = institutionsRepository.findOrCreate(institutionName);
        
        // 사용자 생성
        User admin = new User(email, defaultPassword, Role.ADMIN);
        admin.setInstitution(institution);
        admin.setStatus(ACTIVE);
        usersRepository.save(admin);

        // 초기 설정 로그/알림 등 확장 가능
    }
}

그래서 처음 mvp에서 수동으로 관리자 계정을 만들든, 확장해서 자동으로 관리자 계정을 만들든
adminUserService.create(email, institutionName, purpose); 이것만 쓰면됨

# **✅ 1-2. 관리자 초기 설정

---

## **🧩 1. 기능 정의**

|**기능 항목**|**설명**|**확정 상태**|
|---|---|---|
|공간 등록|평면 구조로 시작하되, DB에는 parent_location_id 포함하여 계층 구조 확장 대비|✅|
|기기 등록|기기명, 상태, 위치 등록. device_type, serial_number, is_active 필드 포함|✅|
|예약 불가 시간 등록 (단일)|기기별 단일 점검 시간대 예약 차단 (start_time ~ end_time)|✅|
|예약 불가 시간 등록 (반복)|요일별 반복 점검 시간대 등록 (예: 매주 화요일 13~15시)|✅ _MVP 포함 확정_|
|기기 상태 수동 설정|FAULT 등 특수 상태로 수동 변경 가능. 상태 변경 이력 추적용 테이블 연계|✅|

---

## **🗃 2. DB 구조**

|**테이블**|**필드 요약**|**확정 여부**|
|---|---|---|
|locations|institution_id, name, parent_location_id (nullable)|✅|
|devices|device_name, location_id, device_type, serial_number, is_active, status|✅|
|devices_maintenance|device_id, start_time, end_time, reason (단일 시간용)|✅|
|devices_maintenance_repeat|device_id, weekday, start_time, end_time (반복용)|✅ _MVP 포함_|
|device_status_logs|device_id, old_status, new_status, changed_by, timestamp (상태 이력 기록용)|✅ _설계 확정, MVP 구현 선택사항_|

---

## **🚨 3. 예외 대응**

|**상황**|**처리 방식**|**확정 여부**|
|---|---|---|
|공간 미등록 상태에서 기기 등록|등록 차단 + 공간 등록 페이지 링크 제공|✅|
|예약 불가 시간 중복 등록|서버 측에서 겹치는 시간 검증|✅|
|유지보수 시간 시간순 오류|start_time ≥ end_time 방지 로직 적용|✅|
|기기 상태 초기값 오류|등록 시 AVAILABLE로 강제 지정|✅|
|NFC/QR 미입력|nfc_tag_url nullable + “나중에 입력” 체크박스 제공|✅|

---

## **🧠 4. UX 설계**

|**UI 요소**|**설계 방식**|**확정 여부**|
|---|---|---|
|공간 등록|간단한 이름 입력 폼 + 중복 체크 / 계층 구조는 추후 전환 가능|✅|
|기기 등록|공간 선택 드롭다운, 상태 표시, NFC/QR 필드 선택적|✅|
|예약 불가 시간|기본 시간대 + “반복 등록” 구간 나누어 표시, 반복은 요일 멀티체크 방식|✅|
|상태 수동 변경|기기 상세에서만 조작 가능, 관리자용 제한 UI|✅|

---

## **🔚 종합 판단**

|**관점**|**평가**|
|---|---|
|기능 정의|📌 확정된 요구사항 기반, 현실적인 MVP 범위 설정 완료|
|DB 구조|📌 확장성, 정합성, 상태 추적 기반까지 고려된 설계|
|예외 처리|📌 모든 주요 예외에 대한 UX 및 로직 처리 포함|
|UX 전략|📌 관리자의 실제 사용 시나리오 기반으로 충분한 가시성 제공|

---

✅ 이 구성은 MVP 구현 + 확장 기반 설계서, 보고서, 개발 명세서에 그대로 반영 가능해.

다음 단계로 **1-3. 사용자 등록 및 권한 흐름 점검**을 진행할 준비가 되었으면 “1-3 점검하자”라고 말해줘!


















//엣날에 정의한 것들

- 사용자기능

| **기능**         | **설명**                         |
| -------------- | ------------------------------ |
| ✅ 기기 상태 확인     | 사용 가능 / 사용 중 / 고장 상태 확인        |
| ✅ 사용 등록        | 빈 기기 선택 → 예상 사용 시간 입력 → 등록     |
| ✅ 사용 종료 / 회수   | 사용 후 완료 표시 → 회수 시간 기록          |
| ✅ 무단 사용 신고     | 비등록 상태 기기 사용 시 신고 가능           |
| ✅ 남은 시간 기록     | 무단 사용 중 기기에 남은 시간 수동 입력        |
| ✅ 알림 수신        | 예약 완료, 종료 임박, 공지 등 웹 알림 수신     |
| ✅ 알림 확인        | 접속 시 공지 팝업, 알림센터에서 확인          |
| ✅ 사용 내역 보기     | 자신의 등록 내역 및 회수 상태 확인           |
| ✅ 로그인 / 자동 로그인 | PWA에서 자동 로그인 (localStorage 기반) |

- 사용자 행동시나리오 기반 기능정리

| 사용자 행동              | 시스템 동작                                 | 관련 관리자 기능                         |
| ------------------- | -------------------------------------- | --------------------------------- |
| 기기 사용 시작            | 사용 등록 (예상 시간 입력) → 상태 `IN_USE` 전환      | 권한 확인 / 상태 기록 / 로그 저장             |
| 기기 사용 종료            | 사용 종료 버튼 → 회수 시간 자동입력 → 상태 `DONE`      | 회수율 반영 / 예약 통계 증가                 |
| 남이 무단 사용 중임         | 무단 사용 신고 → 상태 `SUSPECTED_IN_USE`       | 피신고자 기록 / 거짓신고 확인 / 경고 누적         |
| 내가 등록하지 않은 기기지만 돌아감 | 남은 시간 입력 → 상태 `IN_USE_UNREGISTERED`    | 관리자 확인 필요 알림 생성                   |
| 내 사용 내역 보기          | 사용 내역 조회 (상태/회수 포함)                    | 통계 반영, 사용자 활동 기록 열람               |
| 공지/알림 확인            | 접속 시 팝업 + 알림센터 내역 확인                   | 관리자 공지 작성/발송 로그 확인                |
| 고장신고                | 고장 신고 → 기기 상태 FAULT_REPORTED (신고 접수 중) | 관리자 접수 시 상태 FAULT_CONFIRMED 으로 전환 |
|                     |                                        |                                   |

---


    
- 관리자기능

| **기능**                    | **설명**                           |
| ------------------------- | -------------------------------- |
| ✅ 기기 등록 / 수정 / 삭제         | 공간 단위로 세탁기/건조기 관리                |
| ✅ 고장 처리                   | 고장 신고 기기 수리 상태 변경                |
| ✅ 권한 설정 (Room → Location) | 사용자 권한 배정 및 fallback/override 설정 |
| ✅ 사용자 관리                  | 사용자 목록 필터링, 상태 확인                |
| ✅ 관리자 계정 관리               | 계정 생성 / 비활성화 / 역할 변경             |
| ✅ 알림 작성 및 발송              | 특정 사용자 또는 전체 대상 공지 발송            |
| ✅ 통계 확인                   | 예약 수, 고장 수, 회수율 등 통계 확인          |
| ✅ 감사 로그 확인                | 관리자 행동 이력 확인 (AdminActionLog)    |
| Nfc 기기별 사용 가능여부 설정        |                                  |

- 관리자 행동흐름 기준 기능

|              |                                                         |
| ------------ | ------------------------------------------------------- |
| 관리자 행동       | 관련 기능 흐름                                                |
| 기기 설치        | 기기 등록 → 공간(Location) 지정 → 초기 상태 설정                      |
| 기기 고장 접수     | 고장 신고 상태 FAULT_REPORTED 확인 → 접수 시 상태 FAULT_CONFIRMED 변경 |
| 고장 처리 완료     | 상태 복구 (`AVAILABLE`) → 관리자 로그 기록                         |
| 사용자 권한 요청 처리 | Room → Location 권한 재배정 or override 설정                   |
| 회수율 모니터링     | 회수율/신고율/사용률 통계 확인 페이지 접속                                |
| 관리자 계정 관리    | 계정 생성/비활성화/역할 부여 → 상태/로그인 제한 적용                         |
| 정기 점검        | `last_login_at` 기준 미사용 관리자 파악 → 상태 변경 or 알림 발송          |
| 시스템 공지 작성    | Notification 생성 → 사용자 알림센터 + 팝업 전달                      |


---

## **🔁 공통 기능**

|**기능**|**설명**|
|---|---|
|✅ 로그인 / 인증 처리|JWT + role 기반 인증 처리|
|✅ 알림 수신 처리|PWA + Service Worker 알림 등록|
|✅ 권한 검사|role, institution_id 기반 API 접근 제어|
|✅ last_login_at 기록|로그인 시점 자동 업데이트|
|✅ 상태 동기화|예약 상태 자동 갱신 / 기기 상태 갱신 로직 포함|
- JWT 기반 로그인 + `role` 체크
    
- 모든 주요 테이블에 `institution_id` 포함 (멀티테넌시 구조)
    
- `AdminActionLog` 기록 구조 반영 (기기/권한/알림 관련 행동)
    
- 알림 구조: 웹 푸시 기반, 추후 카카오/밴드 등 확장 가능
    
- Soft Delete (`deleted_at`) 기반 삭제 설계 적용
 - 역할 기반 분리 예시

|**사용자 유형**|**기능 권한**|
|---|---|
|일반 사용자|사용 등록, 회수, 신고, 알림 확인|
|관리자 (MANAGER)|기기/고장/권한 관리, 일부 알림 가능|
|최고 관리자 (SUPER_ADMIN)|모든 권한, 계정 생성/관리, 감사 로그 확인|

  
### **[사용자 기능]**

| **기능**                | **설명**                                                                     |
| --------------------- | -------------------------------------------------------------------------- |
| **1. 로그인/로그아웃**       | - 사용자 로그인 / 로그아웃- PWA로 로그인 상태 유지 (localStorage)                            |
| **2. 출발해요**           | - 기기 선택 후 출발해요 신청- 10분간 도착 대기 상태로 전환- 도착하지 않으면 자동 취소 30분간 출발해요 기능 사용 불가    |
| **3. 도착해요 (NFC인증)**   | - NFC 스캔으로 도착해요 확인- NTAG 424 DNA 동적 URL로 사용자 인증- 인증 완료 시, 사용 등록 가능         |
| **4. 사용 등록**          | - 도착해요 완료 후, 사용 시간 설정 및 등록- 사용 시간 등록 시, 기기 상태 IN_USE로 전환                   |
| **5. 사용 종료 (회수 완료)**  | - 사용 완료 시, 사용 종료 버튼 클릭- 기기 상태를 DONE으로 변경하고 회수 시간 기록                        |
| **6. 무단 사용 신고**       | - 기기가 사용 중이 아닌데 사용 중으로 표시된 경우- 무단 사용 신고 가능- 관리자는 해당 신고를 검토하고, 무단 사용 상태로 전환 |
| **7. 상태 이상 신고**       | - 기기 고장 또는 상태 이상 발견 시 신고- 신고 상태 FAULT_REPORTED로 전환                         |
| **8. 내 기기 확인**        | - 현재 사용 중인 기기 목록 확인- 사용 시간, 남은 시간 표시                                       |
| **9. 알림 확인 (PWA 푸시)** | - 예약 시간 종료, 무단 사용 신고 등 주요 알림 수신- PWA 푸시 알림 및 알림센터에서 확인                     |
| **10. 마이페이지**         | - 사용자 정보 확인 및 비밀번호 변경- 내 신고 내역 / 내 기기 목록 확인                                |

---

### **✅** 

### **[관리자 기능]**

|**기능**|**설명**|
|---|---|
|**1. 관리자 로그인**|- 관리자 전용 로그인 화면|
|**2. 기기 등록/수정/삭제**|- 기기 정보 등록 (위치, 기기명, NFC/QR URL)- 기기 상태 변경 (AVAILABLE, IN_USE, FAULT_REPORTED)|
|**3. 출발해요 / 도착해요 관리**|- 출발해요 대기 중인 사용자 목록 확인- 도착해요 상태 강제 승인|
|**4. 무단 사용 신고 관리**|- 무단 사용 신고 내역 확인- 사용자에게 경고 알림 전송- 신고 내역 기록|
|**5. 상태 이상 신고 관리**|- 고장 신고 내역 확인- FAULT_CONFIRMED로 전환 후, 수리 진행|
|**6. 사용자 관리**|- 사용자 목록 확인- 특정 사용자 권한 변경- 사용 내역 조회|
|**7. 알림 발송**|- 특정 사용자 또는 전 사용자에게 공지 알림 발송|
|**8. 통계/로그 확인**|- 기기별 사용률, 무단 사용 신고 횟수, 고장 신고 내역 등 통계 제공|
|**9. 대체 권한 설정**|- 특정 기기 또는 공간이 고장난 경우- 임시 권한 부여하여 다른 기기 사용 가능하도록 설정|
|**10. 시스템 점검 모드**|- 전체 기기 상태 일괄 변경 (점검 중, 유지보수 중 등)|






### **✅** 

### **[알림 정책]**

| **이벤트**                                  | **알림 내용**                                 | **알림 대상** |
| ---------------------------------------- | ----------------------------------------- | --------- |
| **출발해요 대기 시작** (이미 한명이 있을시 대기줄 세워~? 말어?) | “출발해요가 시작되었습니다. 10분 내에 도착해요를 완료하세요.”      | 사용자       |
| **출발해요 취소됨**                             | “출발해요가 취소되었습니다. 다시 시도해 주세요.”              | 사용자       |
| **도착했어요 시작**                             | “도착했어요가 시작되었습니다. 5분 내에 사용 등록을 완료하세요.”     | 사용자       |
| **사용 등록 완료**                             | “세탁기 사용이 등록되었습니다. 사용 시간을 확인하세요.”          | 사용자       |
| **사용 종료 시간 도래**                          | “사용 시간이 5분 남았습니다. 세탁물을 회수해 주세요.”          | 사용자       |
| **회수 시간 초과**                             | “세탁물 회수 시간이 초과되었습니다. 다른 사용자가 신고할 수 있습니다.” | 사용자       |
| **무단 사용 신고 접수됨**                         | “무단 사용 신고가 접수되었습니다. 사용 내역을 확인해 주세요.”      | 관리자, 사용자  |
| **고장 신고 접수됨**                            | “기기 고장 신고가 접수되었습니다. 관리자에게 보고되었습니다.”       | 관리자, 사용자  |
| **관리자 공지 발송됨**                           | “시스템 점검 공지가 도착했습니다. 확인해 주세요.”             | 전체 사용자    |


외부 알림 연동 (카카오/밴드)|🔄 가능|구조만 준비, 실제 연동은 추후 선택|
